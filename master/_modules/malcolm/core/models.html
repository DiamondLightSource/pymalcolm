<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>malcolm.core.models &mdash; malcolm 6.0+7.ga72f1d3b documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/graphviz.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/theme_overrides.css" type="text/css" />
    <link rel="shortcut icon" href="../../../_static/malcolm-logo.ico"/>
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: rgb(7, 43, 93)" >
            <a href="../../../contents.html" class="icon icon-home"> malcolm
            <img src="../../../_static/malcolm-logo.svg" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                6.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Introduction</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../index.html">Introduction</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials/hello.html">Hello World Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials/counter.html">Counter Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials/motion.html">Motion Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials/detector.html">Detector Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials/scanning.html">Scanning Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials/areadetector.html">AreaDetector Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials/pmac.html">PMAC Master Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials/panda.html">PandA Master Tutorial</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../reference/glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../reference/structure.html">Block Structure</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../reference/messages.html">Message Structure</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../reference/tags.html">Supported Tags</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../reference/statesets.html">State Sets and Hooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../reference/infos.html">Infos</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../reference/datasets.html">Datasets and Detectors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../reference/triggering.html">Trajectory Scan Triggering</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../reference/contributing.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../reference/release_notes.html">Change Log</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../api/core_api.html">malcolm.core</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/yamlutil_api.html">malcolm.yamlutil</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../build/modules_api.html">malcolm.modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/external_api.html">External modules</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Appendix</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="genindex.html#http://">Index</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: rgb(7, 43, 93)" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../contents.html">malcolm</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../contents.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../../index.html">Module code</a> &raquo;</li>
      <li>malcolm.core.models</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for malcolm.core.models</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">Enum</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Any</span><span class="p">,</span>
    <span class="n">Callable</span><span class="p">,</span>
    <span class="n">Dict</span><span class="p">,</span>
    <span class="n">List</span><span class="p">,</span>
    <span class="n">Mapping</span><span class="p">,</span>
    <span class="n">Optional</span><span class="p">,</span>
    <span class="n">Sequence</span><span class="p">,</span>
    <span class="n">Set</span><span class="p">,</span>
    <span class="n">Tuple</span><span class="p">,</span>
    <span class="n">Type</span><span class="p">,</span>
    <span class="n">Union</span><span class="p">,</span>
    <span class="n">cast</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">annotypes</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">NO_DEFAULT</span><span class="p">,</span>
    <span class="n">Anno</span><span class="p">,</span>
    <span class="n">Array</span><span class="p">,</span>
    <span class="n">FrozenOrderedDict</span><span class="p">,</span>
    <span class="n">Serializable</span><span class="p">,</span>
    <span class="n">WithCallTypes</span><span class="p">,</span>
    <span class="n">deserialize_object</span><span class="p">,</span>
    <span class="n">to_array</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">from</span> <span class="nn">malcolm.compat</span> <span class="kn">import</span> <span class="n">OrderedDict</span>

<span class="kn">from</span> <span class="nn">.alarm</span> <span class="kn">import</span> <span class="n">Alarm</span>
<span class="kn">from</span> <span class="nn">.camel</span> <span class="kn">import</span> <span class="n">camel_to_title</span>
<span class="kn">from</span> <span class="nn">.notifier</span> <span class="kn">import</span> <span class="n">DummyNotifier</span><span class="p">,</span> <span class="n">Notifier</span>
<span class="kn">from</span> <span class="nn">.table</span> <span class="kn">import</span> <span class="n">Table</span>
<span class="kn">from</span> <span class="nn">.tags</span> <span class="kn">import</span> <span class="n">Widget</span><span class="p">,</span> <span class="n">method_return_unpacked</span>
<span class="kn">from</span> <span class="nn">.timestamp</span> <span class="kn">import</span> <span class="n">TimeStamp</span>


<span class="k">def</span> <span class="nf">check_type</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">typ</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">typ</span> <span class="o">!=</span> <span class="n">Any</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">typ</span><span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;Expected </span><span class="si">{</span><span class="n">typ</span><span class="si">}</span><span class="s2">, got </span><span class="si">{</span><span class="n">value</span><span class="si">!r}</span><span class="s2">&quot;</span>


<div class="viewcode-block" id="Model"><a class="viewcode-back" href="../../../api/core_api.html#malcolm.core.Model">[docs]</a><span class="k">class</span> <span class="nc">Model</span><span class="p">(</span><span class="n">Serializable</span><span class="p">):</span>
    <span class="n">notifier</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Notifier</span><span class="p">,</span> <span class="n">DummyNotifier</span><span class="p">]</span> <span class="o">=</span> <span class="n">DummyNotifier</span><span class="p">()</span>
    <span class="n">path</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="vm">__slots__</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

<div class="viewcode-block" id="Model.set_notifier_path"><a class="viewcode-back" href="../../../api/core_api.html#malcolm.core.Model.set_notifier_path">[docs]</a>    <span class="k">def</span> <span class="nf">set_notifier_path</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">notifier</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Notifier</span><span class="p">,</span> <span class="n">DummyNotifier</span><span class="p">],</span> <span class="n">path</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Sets the notifier, and the path from the path from block root</span>

<span class="sd">        Args:</span>
<span class="sd">            notifier (Notifier): The Notifier to tell when endpoint data changes</span>
<span class="sd">            path (list): The absolute path to get to this object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># This function should either change from the DummyNotifier or to</span>
        <span class="c1"># the DummyNotifier, never between two valid notifiers</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">notifier</span> <span class="ow">is</span> <span class="n">Model</span><span class="o">.</span><span class="n">notifier</span> <span class="ow">or</span> <span class="n">notifier</span> <span class="ow">is</span> <span class="n">Model</span><span class="o">.</span><span class="n">notifier</span>
        <span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;Already have a notifier </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">notifier</span><span class="si">}</span><span class="s2"> path </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">notifier</span> <span class="o">=</span> <span class="n">notifier</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>
        <span class="c1"># Tell all our children too</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">ct</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">call_types</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">ct</span><span class="o">.</span><span class="n">is_mapping</span><span class="p">:</span>
                <span class="n">child</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">child</span> <span class="ow">and</span> <span class="n">Model</span><span class="o">.</span><span class="n">matches_type</span><span class="p">(</span><span class="n">ct</span><span class="o">.</span><span class="n">typ</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">child</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="n">v</span><span class="o">.</span><span class="n">set_notifier_path</span><span class="p">(</span><span class="n">notifier</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">+</span> <span class="p">[</span><span class="n">name</span><span class="p">,</span> <span class="n">k</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">Model</span><span class="o">.</span><span class="n">matches_type</span><span class="p">(</span><span class="n">ct</span><span class="o">.</span><span class="n">typ</span><span class="p">):</span>
                <span class="k">assert</span> <span class="ow">not</span> <span class="n">ct</span><span class="o">.</span><span class="n">is_array</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Can&#39;t deal with Arrays of Models </span><span class="si">{</span><span class="n">ct</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">child</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                <span class="n">child</span><span class="o">.</span><span class="n">set_notifier_path</span><span class="p">(</span><span class="n">notifier</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">+</span> <span class="p">[</span><span class="n">name</span><span class="p">])</span></div>

    <span class="k">def</span> <span class="nf">set_endpoint_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ct</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">call_types</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">!r}</span><span class="s2"> not in </span><span class="si">{</span><span class="bp">self</span><span class="si">!r}</span><span class="s2">.call_types </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">call_types</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ct</span><span class="o">.</span><span class="n">is_array</span><span class="p">:</span>
                <span class="c1"># Cast to right type, this will do some cheap validation</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">Array</span><span class="p">,</span> <span class="n">ct</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
                <span class="c1"># Check we have the right type</span>
                <span class="k">assert</span> <span class="ow">not</span> <span class="n">Model</span><span class="o">.</span><span class="n">matches_type</span><span class="p">(</span>
                    <span class="n">ct</span><span class="o">.</span><span class="n">typ</span>
                <span class="p">),</span> <span class="s2">&quot;Can&#39;t handle Array[Model] at the moment&quot;</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">seq</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
                    <span class="c1"># Variable array, check types of each instance</span>
                    <span class="c1"># TODO: this might harm performance</span>
                    <span class="n">typ</span> <span class="o">=</span> <span class="n">ct</span><span class="o">.</span><span class="n">typ</span>
                    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">seq</span><span class="p">:</span>
                        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span>
                            <span class="n">x</span><span class="p">,</span> <span class="n">typ</span>
                        <span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;Expected Array[</span><span class="si">{</span><span class="n">ct</span><span class="o">.</span><span class="n">typ</span><span class="si">!r}</span><span class="s2">], got </span><span class="si">{</span><span class="n">value</span><span class="o">.</span><span class="n">seq</span><span class="si">!r}</span><span class="s2">&quot;</span>
            <span class="k">elif</span> <span class="n">ct</span><span class="o">.</span><span class="n">is_mapping</span><span class="p">:</span>
                <span class="c1"># Check it is the right type</span>
                <span class="n">ktype</span><span class="p">,</span> <span class="n">vtype</span> <span class="o">=</span> <span class="n">ct</span><span class="o">.</span><span class="n">typ</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">check_type</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">ktype</span><span class="p">)</span>
                    <span class="n">check_type</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">vtype</span><span class="p">)</span>
                <span class="c1"># If we are setting structures of Models then sort notification</span>
                <span class="k">if</span> <span class="n">Model</span><span class="o">.</span><span class="n">matches_type</span><span class="p">(</span><span class="n">ct</span><span class="o">.</span><span class="n">typ</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                    <span class="c1"># If we have old Models then stop them notifying</span>
                    <span class="n">child</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="p">{})</span>
                    <span class="k">if</span> <span class="n">child</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">child</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                            <span class="n">v</span><span class="o">.</span><span class="n">set_notifier_path</span><span class="p">(</span><span class="n">Model</span><span class="o">.</span><span class="n">notifier</span><span class="p">,</span> <span class="p">[])</span>
                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="n">v</span><span class="o">.</span><span class="n">set_notifier_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">notifier</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">+</span> <span class="p">[</span><span class="n">name</span><span class="p">,</span> <span class="n">k</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># If we are setting a Model then sort notification</span>
                <span class="k">if</span> <span class="n">Model</span><span class="o">.</span><span class="n">matches_type</span><span class="p">(</span><span class="n">ct</span><span class="o">.</span><span class="n">typ</span><span class="p">):</span>
                    <span class="c1"># If we have an old Model then stop it notifying</span>
                    <span class="n">child</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">child</span><span class="p">:</span>
                        <span class="n">child</span><span class="o">.</span><span class="n">set_notifier_path</span><span class="p">(</span><span class="n">Model</span><span class="o">.</span><span class="n">notifier</span><span class="p">,</span> <span class="p">[])</span>
                    <span class="n">value</span><span class="o">.</span><span class="n">set_notifier_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">notifier</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">+</span> <span class="p">[</span><span class="n">name</span><span class="p">])</span>
                <span class="c1"># Make sure it is the right typ</span>
                <span class="n">check_type</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">ct</span><span class="o">.</span><span class="n">typ</span><span class="p">)</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">notifier</span><span class="o">.</span><span class="n">changes_squashed</span><span class="p">:</span>
                <span class="c1"># Actually set the attribute</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                <span class="c1"># Tell the notifier what changed</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">notifier</span><span class="o">.</span><span class="n">add_squashed_change</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">+</span> <span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="n">value</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">value</span>

<div class="viewcode-block" id="Model.apply_change"><a class="viewcode-back" href="../../../api/core_api.html#malcolm.core.Model.apply_change">[docs]</a>    <span class="k">def</span> <span class="nf">apply_change</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Take a single change from a Delta and apply it to this model&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># This is for a child</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">apply_change</span><span class="p">(</span><span class="n">path</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># This is for us</span>
            <span class="k">assert</span> <span class="p">(</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
            <span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;Cannot process change </span><span class="si">{</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">+</span> <span class="n">path</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;set_</span><span class="si">{</span><span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></div></div>


<span class="c1"># Types used when deserializing to the class</span>
<span class="k">with</span> <span class="n">Anno</span><span class="p">(</span><span class="s2">&quot;Description of what this element represents&quot;</span><span class="p">):</span>
    <span class="n">AMetaDescription</span> <span class="o">=</span> <span class="nb">str</span>
<span class="k">with</span> <span class="n">Anno</span><span class="p">(</span><span class="s2">&quot;Generic text tags for client tools to interpret&quot;</span><span class="p">):</span>
    <span class="n">ATags</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="n">Array</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span>
<span class="k">with</span> <span class="n">Anno</span><span class="p">(</span><span class="s2">&quot;Whether this element is currently writeable&quot;</span><span class="p">):</span>
    <span class="n">AWriteable</span> <span class="o">=</span> <span class="nb">bool</span>
<span class="k">with</span> <span class="n">Anno</span><span class="p">(</span><span class="s2">&quot;A human readable label for the element&quot;</span><span class="p">):</span>
    <span class="n">ALabel</span> <span class="o">=</span> <span class="nb">str</span>

<span class="c1"># A more permissive union to allow a wider range of set_* args</span>
<span class="n">UTags</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="n">ATags</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">str</span><span class="p">]</span>


<span class="k">class</span> <span class="nc">Meta</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base class for describing Blocks, Methods and Attributes&quot;&quot;&quot;</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">,</span> <span class="s2">&quot;tags&quot;</span><span class="p">,</span> <span class="s2">&quot;writeable&quot;</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">description</span><span class="p">:</span> <span class="n">AMetaDescription</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">tags</span><span class="p">:</span> <span class="n">UTags</span> <span class="o">=</span> <span class="p">(),</span>
        <span class="n">writeable</span><span class="p">:</span> <span class="n">AWriteable</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">label</span><span class="p">:</span> <span class="n">ALabel</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_description</span><span class="p">(</span><span class="n">description</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_tags</span><span class="p">(</span><span class="n">tags</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writeable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_writeable</span><span class="p">(</span><span class="n">writeable</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_description</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">description</span><span class="p">:</span> <span class="n">AMetaDescription</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AMetaDescription</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_endpoint_data</span><span class="p">(</span><span class="s2">&quot;description&quot;</span><span class="p">,</span> <span class="n">description</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_tags</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tags</span><span class="p">:</span> <span class="n">UTags</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ATags</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_endpoint_data</span><span class="p">(</span><span class="s2">&quot;tags&quot;</span><span class="p">,</span> <span class="n">tags</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_writeable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">writeable</span><span class="p">:</span> <span class="n">AWriteable</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AWriteable</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_endpoint_data</span><span class="p">(</span><span class="s2">&quot;writeable&quot;</span><span class="p">,</span> <span class="n">writeable</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_label</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">:</span> <span class="n">ALabel</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ALabel</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_endpoint_data</span><span class="p">(</span><span class="s2">&quot;label&quot;</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>


<div class="viewcode-block" id="VMeta"><a class="viewcode-back" href="../../../api/core_api.html#malcolm.core.VMeta">[docs]</a><span class="k">class</span> <span class="nc">VMeta</span><span class="p">(</span><span class="n">Meta</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Abstract base class for validating the values of Attributes&quot;&quot;&quot;</span>

    <span class="n">attribute_class</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="s2">&quot;AttributeModel&quot;</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_annotype_lookup</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">type</span><span class="p">,</span> <span class="nb">bool</span><span class="p">,</span> <span class="nb">bool</span><span class="p">],</span> <span class="n">Type</span><span class="p">[</span><span class="s2">&quot;VMeta&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="vm">__slots__</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

<div class="viewcode-block" id="VMeta.validate"><a class="viewcode-back" href="../../../api/core_api.html#malcolm.core.VMeta.validate">[docs]</a>    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Abstract function to validate a given value</span>

<span class="sd">        Args:</span>
<span class="sd">            value: Value to validate</span>

<span class="sd">        Returns:</span>
<span class="sd">            The validated value if it passes</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="VMeta.create_attribute_model"><a class="viewcode-back" href="../../../api/core_api.html#malcolm.core.VMeta.create_attribute_model">[docs]</a>    <span class="k">def</span> <span class="nf">create_attribute_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initial_value</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;AttributeModel&quot;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Make an AttributeModel instance of the correct type for this Meta</span>

<span class="sd">        Args:</span>
<span class="sd">            initial_value: The initial value the Attribute should take</span>

<span class="sd">        Returns:</span>
<span class="sd">            AttributeModel: The created attribute model instance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">attribute_class</span><span class="p">,</span> <span class="s2">&quot;No attribute class&quot;</span>
        <span class="n">attr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attribute_class</span><span class="p">(</span><span class="n">meta</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">initial_value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">attr</span></div>

<div class="viewcode-block" id="VMeta.doc_type_string"><a class="viewcode-back" href="../../../api/core_api.html#malcolm.core.VMeta.doc_type_string">[docs]</a>    <span class="k">def</span> <span class="nf">doc_type_string</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Abstract function to return the python type string.</span>

<span class="sd">        For example, &quot;str&quot; or &quot;numpy.int32&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="VMeta.default_widget"><a class="viewcode-back" href="../../../api/core_api.html#malcolm.core.VMeta.default_widget">[docs]</a>    <span class="k">def</span> <span class="nf">default_widget</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Widget</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Abstract function to return the default widget type&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="VMeta.from_annotype"><a class="viewcode-back" href="../../../api/core_api.html#malcolm.core.VMeta.from_annotype">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_annotype</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">anno</span><span class="p">:</span> <span class="n">Anno</span><span class="p">,</span> <span class="n">writeable</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;VMeta&quot;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return an instance of this class from an Anno&quot;&quot;&quot;</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="n">anno</span><span class="o">.</span><span class="n">description</span><span class="p">,</span> <span class="n">writeable</span><span class="o">=</span><span class="n">writeable</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">widget</span> <span class="o">=</span> <span class="n">ret</span><span class="o">.</span><span class="n">default_widget</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">widget</span> <span class="o">!=</span> <span class="n">Widget</span><span class="o">.</span><span class="n">NONE</span><span class="p">:</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">set_tags</span><span class="p">([</span><span class="n">widget</span><span class="o">.</span><span class="n">tag</span><span class="p">()])</span>
        <span class="k">return</span> <span class="n">ret</span></div>

<div class="viewcode-block" id="VMeta.register_annotype_converter"><a class="viewcode-back" href="../../../api/core_api.html#malcolm.core.VMeta.register_annotype_converter">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">register_annotype_converter</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">types</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">type</span><span class="p">],</span> <span class="nb">type</span><span class="p">],</span>
        <span class="n">is_array</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">is_mapping</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Anno</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Register this class as a converter for Anno instances&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">types</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">):</span>
            <span class="n">types</span> <span class="o">=</span> <span class="p">[</span><span class="n">types</span><span class="p">]</span>

        <span class="k">def</span> <span class="nf">decorator</span><span class="p">(</span><span class="n">subclass</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">typ</span> <span class="ow">in</span> <span class="n">types</span><span class="p">:</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">_annotype_lookup</span><span class="p">[(</span><span class="n">typ</span><span class="p">,</span> <span class="n">is_array</span><span class="p">,</span> <span class="n">is_mapping</span><span class="p">)]</span> <span class="o">=</span> <span class="n">subclass</span>
            <span class="k">return</span> <span class="n">subclass</span>

        <span class="k">return</span> <span class="n">decorator</span></div>

<div class="viewcode-block" id="VMeta.lookup_annotype_converter"><a class="viewcode-back" href="../../../api/core_api.html#malcolm.core.VMeta.lookup_annotype_converter">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">lookup_annotype_converter</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">anno</span><span class="p">:</span> <span class="n">Anno</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Type</span><span class="p">[</span><span class="s2">&quot;VMeta&quot;</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Look up a vmeta based on an Anno&quot;&quot;&quot;</span>
        <span class="n">bases</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">Tuple</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">anno</span><span class="o">.</span><span class="n">typ</span><span class="p">,</span> <span class="s2">&quot;__bases__&quot;</span><span class="p">):</span>
            <span class="c1"># This is a proper type</span>
            <span class="n">bases</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getmro</span><span class="p">(</span><span class="n">anno</span><span class="o">.</span><span class="n">typ</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># This is a numpy dtype</span>
            <span class="n">bases</span> <span class="o">=</span> <span class="p">[</span><span class="n">anno</span><span class="o">.</span><span class="n">typ</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">typ</span> <span class="ow">in</span> <span class="n">bases</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="nb">bool</span><span class="p">(</span><span class="n">anno</span><span class="o">.</span><span class="n">is_array</span><span class="p">),</span> <span class="nb">bool</span><span class="p">(</span><span class="n">anno</span><span class="o">.</span><span class="n">is_mapping</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_annotype_lookup</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="n">anno</span><span class="p">)</span></div></div>


<span class="c1"># Types used when deserializing to the class</span>
<span class="k">with</span> <span class="n">Anno</span><span class="p">(</span><span class="s2">&quot;The current value of the Attribute&quot;</span><span class="p">):</span>
    <span class="n">AValue</span> <span class="o">=</span> <span class="n">Any</span>
<span class="k">with</span> <span class="n">Anno</span><span class="p">(</span><span class="s2">&quot;The current alarm status&quot;</span><span class="p">):</span>
    <span class="n">AAlarm</span> <span class="o">=</span> <span class="n">Alarm</span>
<span class="k">with</span> <span class="n">Anno</span><span class="p">(</span><span class="s2">&quot;The time when the value was last updated&quot;</span><span class="p">):</span>
    <span class="n">ATimeStamp</span> <span class="o">=</span> <span class="n">TimeStamp</span>
<span class="k">with</span> <span class="n">Anno</span><span class="p">(</span><span class="s2">&quot;The validating Meta object describing our value&quot;</span><span class="p">):</span>
    <span class="n">AVMeta</span> <span class="o">=</span> <span class="n">VMeta</span>


<span class="c1"># Don&#39;t register this with Serializable as we never instantiate it directly,</span>
<span class="c1"># only a subclass like NTScalar</span>
<div class="viewcode-block" id="AttributeModel"><a class="viewcode-back" href="../../../api/core_api.html#malcolm.core.AttributeModel">[docs]</a><span class="k">class</span> <span class="nc">AttributeModel</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Data Model for an Attribute&quot;&quot;&quot;</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">,</span> <span class="s2">&quot;alarm&quot;</span><span class="p">,</span> <span class="s2">&quot;timeStamp&quot;</span><span class="p">,</span> <span class="s2">&quot;meta&quot;</span><span class="p">]</span>

    <span class="c1"># noinspection PyPep8Naming</span>
    <span class="c1"># timeStamp is camelCase to maintain compatibility with EPICS normative</span>
    <span class="c1"># types</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">value</span><span class="p">:</span> <span class="n">AValue</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">alarm</span><span class="p">:</span> <span class="n">AAlarm</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">timeStamp</span><span class="p">:</span> <span class="n">ATimeStamp</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">meta</span><span class="p">:</span> <span class="n">AVMeta</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_meta</span><span class="p">(</span><span class="n">meta</span><span class="p">)</span>
        <span class="sd">&quot;&quot;&quot;A Meta object describing the Attribute&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">set_alarm_ts</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="sd">&quot;&quot;&quot;The current value of the Attribute&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alarm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_alarm</span><span class="p">(</span><span class="n">alarm</span><span class="p">)</span>
        <span class="sd">&quot;&quot;&quot;An Alarm object indicating any problems&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timeStamp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_timeStamp</span><span class="p">(</span><span class="n">timeStamp</span><span class="p">)</span>
        <span class="sd">&quot;&quot;&quot;When value was last set&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">set_meta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">meta</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">VMeta</span><span class="p">,</span> <span class="kc">None</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">VMeta</span><span class="p">:</span>
        <span class="n">meta</span> <span class="o">=</span> <span class="n">deserialize_object</span><span class="p">(</span><span class="n">meta</span><span class="p">)</span>
        <span class="c1"># Check that the meta attribute_class is ourself</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span> <span class="n">VMeta</span><span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;Expected meta object, got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">meta</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">meta</span><span class="o">.</span><span class="n">attribute_class</span><span class="p">),</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Meta object needs to be attached to </span><span class="si">{</span><span class="n">meta</span><span class="o">.</span><span class="n">attribute_class</span><span class="si">}</span><span class="s2">, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;we are a </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_endpoint_data</span><span class="p">(</span><span class="s2">&quot;meta&quot;</span><span class="p">,</span> <span class="n">meta</span><span class="p">)</span>

<div class="viewcode-block" id="AttributeModel.set_value"><a class="viewcode-back" href="../../../api/core_api.html#malcolm.core.AttributeModel.set_value">[docs]</a>    <span class="k">def</span> <span class="nf">set_value</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
        <span class="n">set_alarm_ts</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">alarm</span><span class="p">:</span> <span class="n">Alarm</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">ts</span><span class="p">:</span> <span class="n">TimeStamp</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Set value, calculating alarm and ts if requested&quot;&quot;&quot;</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">set_alarm_ts</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">alarm</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">alarm</span> <span class="o">=</span> <span class="n">Alarm</span><span class="o">.</span><span class="n">ok</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">alarm</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">Alarm</span><span class="p">,</span> <span class="n">deserialize_object</span><span class="p">(</span><span class="n">alarm</span><span class="p">,</span> <span class="n">Alarm</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">ts</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ts</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">TimeStamp</span><span class="p">,</span> <span class="n">TimeStamp</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ts</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">TimeStamp</span><span class="p">,</span> <span class="n">deserialize_object</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">TimeStamp</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_value_alarm_ts</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">alarm</span><span class="p">,</span> <span class="n">ts</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_endpoint_data</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span></div>

<div class="viewcode-block" id="AttributeModel.set_value_alarm_ts"><a class="viewcode-back" href="../../../api/core_api.html#malcolm.core.AttributeModel.set_value_alarm_ts">[docs]</a>    <span class="k">def</span> <span class="nf">set_value_alarm_ts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">alarm</span><span class="p">:</span> <span class="n">Alarm</span><span class="p">,</span> <span class="n">ts</span><span class="p">:</span> <span class="n">TimeStamp</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Set value with pre-validated alarm and timeStamp&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">notifier</span><span class="o">.</span><span class="n">changes_squashed</span><span class="p">:</span>
            <span class="c1"># Assume they are of the right format</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">notifier</span><span class="o">.</span><span class="n">add_squashed_change</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">],</span> <span class="n">value</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">alarm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">alarm</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">alarm</span> <span class="o">=</span> <span class="n">alarm</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">notifier</span><span class="o">.</span><span class="n">add_squashed_change</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;alarm&quot;</span><span class="p">],</span> <span class="n">alarm</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">timeStamp</span> <span class="o">=</span> <span class="n">ts</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">notifier</span><span class="o">.</span><span class="n">add_squashed_change</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;timeStamp&quot;</span><span class="p">],</span> <span class="n">ts</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">set_alarm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alarm</span><span class="p">:</span> <span class="n">Alarm</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Alarm</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">alarm</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">alarm</span> <span class="o">=</span> <span class="n">Alarm</span><span class="o">.</span><span class="n">ok</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">alarm</span> <span class="o">=</span> <span class="n">deserialize_object</span><span class="p">(</span><span class="n">alarm</span><span class="p">,</span> <span class="n">Alarm</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_endpoint_data</span><span class="p">(</span><span class="s2">&quot;alarm&quot;</span><span class="p">,</span> <span class="n">alarm</span><span class="p">)</span>

    <span class="c1"># noinspection PyPep8Naming</span>
    <span class="c1"># timeStamp is camelCase to maintain compatibility with EPICS normative</span>
    <span class="c1"># types</span>
    <span class="k">def</span> <span class="nf">set_timeStamp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ts</span><span class="p">:</span> <span class="n">TimeStamp</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TimeStamp</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">ts</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ts</span> <span class="o">=</span> <span class="n">TimeStamp</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ts</span> <span class="o">=</span> <span class="n">deserialize_object</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">TimeStamp</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_endpoint_data</span><span class="p">(</span><span class="s2">&quot;timeStamp&quot;</span><span class="p">,</span> <span class="n">ts</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">apply_change</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">path</span> <span class="o">==</span> <span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">args</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">set_alarm_ts</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">apply_change</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span></div>


<div class="viewcode-block" id="NTTable"><a class="viewcode-back" href="../../../api/core_api.html#malcolm.core.NTTable">[docs]</a><span class="nd">@Serializable</span><span class="o">.</span><span class="n">register_subclass</span><span class="p">(</span><span class="s2">&quot;epics:nt/NTTable:1.0&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">NTTable</span><span class="p">(</span><span class="n">AttributeModel</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;AttributeModel containing a `TableMeta`&quot;&quot;&quot;</span>

    <span class="vm">__slots__</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">set_value_alarm_ts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">AValue</span><span class="p">,</span> <span class="n">alarm</span><span class="p">:</span> <span class="n">Alarm</span><span class="p">,</span> <span class="n">ts</span><span class="p">:</span> <span class="n">TimeStamp</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">notifier</span><span class="o">.</span><span class="n">changes_squashed</span><span class="p">:</span>
            <span class="c1"># Assume they are of the right format</span>
            <span class="c1"># Work out what changed in value, do a cheap Array id check</span>
            <span class="n">changed</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">value</span> <span class="k">if</span> <span class="n">value</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">changed</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">call_types</span><span class="p">):</span>
                <span class="c1"># Everything changed</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">notifier</span><span class="o">.</span><span class="n">add_squashed_change</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">],</span> <span class="n">value</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Only some changed</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">changed</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">notifier</span><span class="o">.</span><span class="n">add_squashed_change</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">,</span> <span class="n">k</span><span class="p">],</span> <span class="n">value</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                    <span class="p">)</span>
            <span class="k">if</span> <span class="n">alarm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">alarm</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">alarm</span> <span class="o">=</span> <span class="n">alarm</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">notifier</span><span class="o">.</span><span class="n">add_squashed_change</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;alarm&quot;</span><span class="p">],</span> <span class="n">alarm</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">timeStamp</span> <span class="o">=</span> <span class="n">ts</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">notifier</span><span class="o">.</span><span class="n">add_squashed_change</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;timeStamp&quot;</span><span class="p">],</span> <span class="n">ts</span><span class="p">)</span></div>


<div class="viewcode-block" id="NTScalarArray"><a class="viewcode-back" href="../../../api/core_api.html#malcolm.core.NTScalarArray">[docs]</a><span class="nd">@Serializable</span><span class="o">.</span><span class="n">register_subclass</span><span class="p">(</span><span class="s2">&quot;epics:nt/NTScalarArray:1.0&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">NTScalarArray</span><span class="p">(</span><span class="n">AttributeModel</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;AttributeModel containing a `VArrayMeta`&quot;&quot;&quot;</span>

    <span class="vm">__slots__</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span></div>


<div class="viewcode-block" id="NTScalar"><a class="viewcode-back" href="../../../api/core_api.html#malcolm.core.NTScalar">[docs]</a><span class="nd">@Serializable</span><span class="o">.</span><span class="n">register_subclass</span><span class="p">(</span><span class="s2">&quot;epics:nt/NTScalar:1.0&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">NTScalar</span><span class="p">(</span><span class="n">AttributeModel</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;AttributeModel containing a `StringMeta`, `BooleanMeta`, `NumberMeta`</span>
<span class="sd">    or `ChoiceMeta`</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="vm">__slots__</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span></div>


<div class="viewcode-block" id="NTUnion"><a class="viewcode-back" href="../../../api/core_api.html#malcolm.core.NTUnion">[docs]</a><span class="nd">@Serializable</span><span class="o">.</span><span class="n">register_subclass</span><span class="p">(</span><span class="s2">&quot;epics:nt/NTUnion:1.0&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">NTUnion</span><span class="p">(</span><span class="n">AttributeModel</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;AttributeModel containing a meta producing some object structure&quot;&quot;&quot;</span>

    <span class="vm">__slots__</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span></div>


<span class="n">FALSE_STRINGS</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="s2">&quot;False&quot;</span><span class="p">,</span> <span class="s2">&quot;false&quot;</span><span class="p">,</span> <span class="s2">&quot;FALSE&quot;</span><span class="p">,</span> <span class="s2">&quot;No&quot;</span><span class="p">,</span> <span class="s2">&quot;no&quot;</span><span class="p">,</span> <span class="s2">&quot;NO&quot;</span><span class="p">}</span>


<div class="viewcode-block" id="BooleanMeta"><a class="viewcode-back" href="../../../api/core_api.html#malcolm.core.BooleanMeta">[docs]</a><span class="nd">@Serializable</span><span class="o">.</span><span class="n">register_subclass</span><span class="p">(</span><span class="s2">&quot;malcolm:core/BooleanMeta:1.0&quot;</span><span class="p">)</span>
<span class="nd">@VMeta</span><span class="o">.</span><span class="n">register_annotype_converter</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">BooleanMeta</span><span class="p">(</span><span class="n">VMeta</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Meta object containing information for a boolean&quot;&quot;&quot;</span>

    <span class="n">attribute_class</span> <span class="o">=</span> <span class="n">NTScalar</span>
    <span class="vm">__slots__</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

<div class="viewcode-block" id="BooleanMeta.validate"><a class="viewcode-back" href="../../../api/core_api.html#malcolm.core.BooleanMeta.validate">[docs]</a>    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Cast value to boolean and return it&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">FALSE_STRINGS</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">doc_type_string</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;bool&quot;</span>

    <span class="k">def</span> <span class="nf">default_widget</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Widget</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">writeable</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Widget</span><span class="o">.</span><span class="n">CHECKBOX</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Widget</span><span class="o">.</span><span class="n">LED</span></div>


<span class="k">with</span> <span class="n">Anno</span><span class="p">(</span><span class="s2">&quot;Choices of valid strings&quot;</span><span class="p">):</span>
    <span class="n">AChoices</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="n">Array</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span>

<span class="n">UChoices</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="n">AChoices</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Enum</span><span class="p">],</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span>


<div class="viewcode-block" id="ChoiceMeta"><a class="viewcode-back" href="../../../api/core_api.html#malcolm.core.ChoiceMeta">[docs]</a><span class="nd">@Serializable</span><span class="o">.</span><span class="n">register_subclass</span><span class="p">(</span><span class="s2">&quot;malcolm:core/ChoiceMeta:1.0&quot;</span><span class="p">)</span>
<span class="nd">@VMeta</span><span class="o">.</span><span class="n">register_annotype_converter</span><span class="p">(</span><span class="n">Enum</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">ChoiceMeta</span><span class="p">(</span><span class="n">VMeta</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Meta object containing information for a enum&quot;&quot;&quot;</span>

    <span class="n">attribute_class</span> <span class="o">=</span> <span class="n">NTScalar</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;choices&quot;</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">description</span><span class="p">:</span> <span class="n">AMetaDescription</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">choices</span><span class="p">:</span> <span class="n">UChoices</span> <span class="o">=</span> <span class="p">(),</span>
        <span class="n">tags</span><span class="p">:</span> <span class="n">UTags</span> <span class="o">=</span> <span class="p">(),</span>
        <span class="n">writeable</span><span class="p">:</span> <span class="n">AWriteable</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">label</span><span class="p">:</span> <span class="n">ALabel</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">description</span><span class="p">,</span> <span class="n">tags</span><span class="p">,</span> <span class="n">writeable</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">choices_lookup</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Enum</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># Used for ChoiceMetaArray subclass only for producing Arrays</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enum_cls</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Type</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">choices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_choices</span><span class="p">(</span><span class="n">choices</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_choices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">choices</span><span class="p">:</span> <span class="n">UChoices</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AChoices</span><span class="p">:</span>
        <span class="c1"># Calculate a lookup from all possible entries to the choice value</span>
        <span class="n">choices_lookup</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Enum</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">new_choices</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Enum</span><span class="p">]]</span>
        <span class="n">new_choices</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># type: ignore</span>
        <span class="n">enum_typ</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Type</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">choice</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">object</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">choice</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">choices</span><span class="p">):</span>
            <span class="c1"># If we already have an enum type it must match</span>
            <span class="k">if</span> <span class="n">enum_typ</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span>
                    <span class="n">choice</span><span class="p">,</span> <span class="n">enum_typ</span>
                <span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;Expected </span><span class="si">{</span><span class="n">enum_typ</span><span class="si">}</span><span class="s2"> choice, got </span><span class="si">{</span><span class="n">choice</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">choice</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">enum_typ</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">choice</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">choice</span><span class="p">,</span> <span class="n">Enum</span><span class="p">):</span>
                <span class="c1"># Our choice value must be a string</span>
                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">choice</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Expected Enum choice to have str value, got </span><span class="si">{</span><span class="n">choice</span><span class="si">!r}</span><span class="s2"> with &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;value </span><span class="si">{</span><span class="n">choice</span><span class="o">.</span><span class="n">value</span><span class="si">!r}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="c1"># Map the Enum instance and str to the Enum instance</span>
                <span class="n">choices_lookup</span><span class="p">[</span><span class="n">choice</span><span class="o">.</span><span class="n">value</span><span class="p">]</span> <span class="o">=</span> <span class="n">choice</span>
                <span class="n">choices_lookup</span><span class="p">[</span><span class="n">choice</span><span class="p">]</span> <span class="o">=</span> <span class="n">choice</span>
                <span class="n">new_choices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">choice</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">choice</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;Expected string choice, got </span><span class="si">{</span><span class="n">choice</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="c1"># Map the string to itself</span>
                <span class="n">choices_lookup</span><span class="p">[</span><span class="n">choice</span><span class="p">]</span> <span class="o">=</span> <span class="n">choice</span>
                <span class="n">new_choices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">choice</span><span class="p">)</span>
            <span class="c1"># Map the index to the choice</span>
            <span class="n">choices_lookup</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">choice</span>
        <span class="k">if</span> <span class="n">choices</span><span class="p">:</span>
            <span class="c1"># Map the default value to the first choice</span>
            <span class="n">choices_lookup</span><span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># There are no choices, so the default value is the empty string</span>
            <span class="n">choices_lookup</span><span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">choices_lookup</span> <span class="o">=</span> <span class="n">choices_lookup</span>
        <span class="k">if</span> <span class="n">enum_typ</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">Model</span><span class="o">.</span><span class="n">matches_type</span><span class="p">(</span><span class="n">enum_typ</span><span class="p">):</span>
            <span class="c1"># We are producing strings</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">enum_cls</span> <span class="o">=</span> <span class="nb">str</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># We are producing enums</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">enum_cls</span> <span class="o">=</span> <span class="n">enum_typ</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call_types</span><span class="p">[</span><span class="s2">&quot;choices&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">typ</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">enum_cls</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_endpoint_data</span><span class="p">(</span>
            <span class="s2">&quot;choices&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">call_types</span><span class="p">[</span><span class="s2">&quot;choices&quot;</span><span class="p">](</span><span class="n">new_choices</span><span class="p">)</span>
        <span class="p">)</span>

<div class="viewcode-block" id="ChoiceMeta.validate"><a class="viewcode-back" href="../../../api/core_api.html#malcolm.core.ChoiceMeta.validate">[docs]</a>    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">Enum</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Check if the value is valid returns it&quot;&quot;&quot;</span>
        <span class="c1"># Our lookup table contains all the possible values</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">choices_lookup</span><span class="p">[</span><span class="n">value</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">value</span><span class="si">!r}</span><span class="s2"> is not a valid value in </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">choices</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">doc_type_string</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot; | &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">repr</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">choices</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">default_widget</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Widget</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">writeable</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Widget</span><span class="o">.</span><span class="n">COMBO</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Widget</span><span class="o">.</span><span class="n">TEXTUPDATE</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_annotype</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">anno</span><span class="p">:</span> <span class="n">Anno</span><span class="p">,</span> <span class="n">writeable</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">VMeta</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">from_annotype</span><span class="p">(</span><span class="n">anno</span><span class="p">,</span> <span class="n">writeable</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">anno</span><span class="o">.</span><span class="n">typ</span><span class="p">))</span></div>


<span class="k">with</span> <span class="n">Anno</span><span class="p">(</span><span class="s2">&quot;The lower bound of range within which the value must be set&quot;</span><span class="p">):</span>
    <span class="n">ALimitLow</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]</span>
<span class="n">ULimitLow</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="n">ALimitLow</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>
<span class="k">with</span> <span class="n">Anno</span><span class="p">(</span><span class="s2">&quot;The upper bound of range within which the value must be set&quot;</span><span class="p">):</span>
    <span class="n">ALimitHigh</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]</span>
<span class="n">ULimitHigh</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="n">ALimitHigh</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>
<span class="k">with</span> <span class="n">Anno</span><span class="p">(</span><span class="s2">&quot;Number of significant figures to display&quot;</span><span class="p">):</span>
    <span class="n">APrecision</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">]</span>
<span class="n">UPrecision</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="n">APrecision</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span>
<span class="k">with</span> <span class="n">Anno</span><span class="p">(</span><span class="s2">&quot;The units for the value&quot;</span><span class="p">):</span>
    <span class="n">AUnits</span> <span class="o">=</span> <span class="nb">str</span>


<div class="viewcode-block" id="Display"><a class="viewcode-back" href="../../../api/core_api.html#malcolm.core.Display">[docs]</a><span class="nd">@Serializable</span><span class="o">.</span><span class="n">register_subclass</span><span class="p">(</span><span class="s2">&quot;display_t&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">Display</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;limitLow&quot;</span><span class="p">,</span> <span class="s2">&quot;limitHigh&quot;</span><span class="p">,</span> <span class="s2">&quot;description&quot;</span><span class="p">,</span> <span class="s2">&quot;precision&quot;</span><span class="p">,</span> <span class="s2">&quot;units&quot;</span><span class="p">]</span>

    <span class="c1"># noinspection PyPep8Naming</span>
    <span class="c1"># limitLow and limitHigh are camelCase to maintain compatibility with</span>
    <span class="c1"># EPICS normative types</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">limitLow</span><span class="p">:</span> <span class="n">ULimitLow</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">limitHigh</span><span class="p">:</span> <span class="n">ULimitHigh</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">description</span><span class="p">:</span> <span class="n">AMetaDescription</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">precision</span><span class="p">:</span> <span class="n">UPrecision</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">units</span><span class="p">:</span> <span class="n">AUnits</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Set initial values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">limitLow</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_limitLow</span><span class="p">(</span><span class="n">limitLow</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">limitHigh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_limitHigh</span><span class="p">(</span><span class="n">limitHigh</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_description</span><span class="p">(</span><span class="n">description</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">precision</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_precision</span><span class="p">(</span><span class="n">precision</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_units</span><span class="p">(</span><span class="n">units</span><span class="p">)</span>

    <span class="c1"># noinspection PyPep8Naming</span>
    <span class="c1"># limitLow is camelCase to maintain compatibility with EPICS normative</span>
    <span class="c1"># types</span>
    <span class="k">def</span> <span class="nf">set_limitLow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">limitLow</span><span class="p">:</span> <span class="n">ULimitLow</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ALimitLow</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_endpoint_data</span><span class="p">(</span><span class="s2">&quot;limitLow&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">(</span><span class="n">limitLow</span><span class="p">))</span>

    <span class="c1"># noinspection PyPep8Naming</span>
    <span class="c1"># limitHigh is camelCase to maintain compatibility with EPICS normative</span>
    <span class="c1"># types</span>
    <span class="k">def</span> <span class="nf">set_limitHigh</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">limitHigh</span><span class="p">:</span> <span class="n">ULimitHigh</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ALimitHigh</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_endpoint_data</span><span class="p">(</span><span class="s2">&quot;limitHigh&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">(</span><span class="n">limitHigh</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">set_precision</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">precision</span><span class="p">:</span> <span class="n">UPrecision</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">APrecision</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_endpoint_data</span><span class="p">(</span><span class="s2">&quot;precision&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="n">precision</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">set_units</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">units</span><span class="p">:</span> <span class="n">AUnits</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AUnits</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_endpoint_data</span><span class="p">(</span><span class="s2">&quot;units&quot;</span><span class="p">,</span> <span class="n">units</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_description</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">description</span><span class="p">:</span> <span class="n">AMetaDescription</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AMetaDescription</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_endpoint_data</span><span class="p">(</span><span class="s2">&quot;description&quot;</span><span class="p">,</span> <span class="n">description</span><span class="p">)</span></div>


<span class="k">with</span> <span class="n">Anno</span><span class="p">(</span><span class="s2">&quot;Numpy dtype string&quot;</span><span class="p">):</span>
    <span class="n">ADtype</span> <span class="o">=</span> <span class="nb">str</span>
<span class="k">with</span> <span class="n">Anno</span><span class="p">(</span><span class="s2">&quot;Display info meta object&quot;</span><span class="p">):</span>
    <span class="n">ADisplay</span> <span class="o">=</span> <span class="n">Display</span>

<span class="n">_dtype_strings</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;int8&quot;</span><span class="p">,</span>
    <span class="s2">&quot;uint8&quot;</span><span class="p">,</span>
    <span class="s2">&quot;int16&quot;</span><span class="p">,</span>
    <span class="s2">&quot;uint16&quot;</span><span class="p">,</span>
    <span class="s2">&quot;int32&quot;</span><span class="p">,</span>
    <span class="s2">&quot;uint32&quot;</span><span class="p">,</span>
    <span class="s2">&quot;int64&quot;</span><span class="p">,</span>
    <span class="s2">&quot;uint64&quot;</span><span class="p">,</span>
    <span class="s2">&quot;float32&quot;</span><span class="p">,</span>
    <span class="s2">&quot;float64&quot;</span><span class="p">,</span>
<span class="p">]</span>
<span class="n">_dtype_string_lookup</span> <span class="o">=</span> <span class="p">{</span><span class="nb">getattr</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">dtype</span><span class="p">):</span> <span class="n">dtype</span> <span class="k">for</span> <span class="n">dtype</span> <span class="ow">in</span> <span class="n">_dtype_strings</span><span class="p">}</span>
<span class="n">_dtype_string_lookup</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="nb">int</span><span class="p">:</span> <span class="s2">&quot;int64&quot;</span><span class="p">,</span> <span class="nb">float</span><span class="p">:</span> <span class="s2">&quot;float64&quot;</span><span class="p">})</span>


<div class="viewcode-block" id="NumberMeta"><a class="viewcode-back" href="../../../api/core_api.html#malcolm.core.NumberMeta">[docs]</a><span class="nd">@Serializable</span><span class="o">.</span><span class="n">register_subclass</span><span class="p">(</span><span class="s2">&quot;malcolm:core/NumberMeta:1.0&quot;</span><span class="p">)</span>
<span class="nd">@VMeta</span><span class="o">.</span><span class="n">register_annotype_converter</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">_dtype_string_lookup</span><span class="p">))</span>
<span class="k">class</span> <span class="nc">NumberMeta</span><span class="p">(</span><span class="n">VMeta</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Meta object containing information for a numerical value&quot;&quot;&quot;</span>

    <span class="n">attribute_class</span> <span class="o">=</span> <span class="n">NTScalar</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;dtype&quot;</span><span class="p">,</span> <span class="s2">&quot;display&quot;</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">dtype</span><span class="p">:</span> <span class="n">ADtype</span> <span class="o">=</span> <span class="s2">&quot;float64&quot;</span><span class="p">,</span>
        <span class="n">description</span><span class="p">:</span> <span class="n">AMetaDescription</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">tags</span><span class="p">:</span> <span class="n">UTags</span> <span class="o">=</span> <span class="p">(),</span>
        <span class="n">writeable</span><span class="p">:</span> <span class="n">AWriteable</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">label</span><span class="p">:</span> <span class="n">ALabel</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">display</span><span class="p">:</span> <span class="n">ADisplay</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">description</span><span class="p">,</span> <span class="n">tags</span><span class="p">,</span> <span class="n">writeable</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>
        <span class="c1"># like np.float64</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_np_type</span><span class="p">:</span> <span class="nb">type</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span>
        <span class="c1"># like &quot;float64&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_dtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">display</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Guess some defaults for the display object</span>
            <span class="k">if</span> <span class="n">dtype</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;float32&quot;</span><span class="p">,</span> <span class="s2">&quot;float64&quot;</span><span class="p">]:</span>
                <span class="n">precision</span> <span class="o">=</span> <span class="mi">8</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">precision</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">display</span> <span class="o">=</span> <span class="n">Display</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="n">precision</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">display</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_display</span><span class="p">(</span><span class="n">display</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_display</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">display</span><span class="p">:</span> <span class="n">ADisplay</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ADisplay</span><span class="p">:</span>
        <span class="n">display</span> <span class="o">=</span> <span class="n">deserialize_object</span><span class="p">(</span><span class="n">display</span><span class="p">,</span> <span class="n">Display</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_endpoint_data</span><span class="p">(</span><span class="s2">&quot;display&quot;</span><span class="p">,</span> <span class="n">display</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_dtype</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="n">ADtype</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ADtype</span><span class="p">:</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="n">dtype</span> <span class="ow">in</span> <span class="n">_dtype_strings</span>
        <span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;Expected dtype to be in </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_dtypes</span><span class="si">}</span><span class="s2">, got </span><span class="si">{</span><span class="n">dtype</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_np_type</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_endpoint_data</span><span class="p">(</span><span class="s2">&quot;dtype&quot;</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span>

<div class="viewcode-block" id="NumberMeta.validate"><a class="viewcode-back" href="../../../api/core_api.html#malcolm.core.NumberMeta.validate">[docs]</a>    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Check if the value is valid returns it&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">cast</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_np_type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cast</span></div>

    <span class="k">def</span> <span class="nf">doc_type_string</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">def</span> <span class="nf">default_widget</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Widget</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">writeable</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Widget</span><span class="o">.</span><span class="n">TEXTINPUT</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Widget</span><span class="o">.</span><span class="n">TEXTUPDATE</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_annotype</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">anno</span><span class="p">:</span> <span class="n">Anno</span><span class="p">,</span> <span class="n">writeable</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">VMeta</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">from_annotype</span><span class="p">(</span>
            <span class="n">anno</span><span class="p">,</span> <span class="n">writeable</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">_dtype_string_lookup</span><span class="p">[</span><span class="n">anno</span><span class="o">.</span><span class="n">typ</span><span class="p">]</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="StringMeta"><a class="viewcode-back" href="../../../api/core_api.html#malcolm.core.StringMeta">[docs]</a><span class="nd">@Serializable</span><span class="o">.</span><span class="n">register_subclass</span><span class="p">(</span><span class="s2">&quot;malcolm:core/StringMeta:1.0&quot;</span><span class="p">)</span>
<span class="nd">@VMeta</span><span class="o">.</span><span class="n">register_annotype_converter</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">StringMeta</span><span class="p">(</span><span class="n">VMeta</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Meta object containing information for a string&quot;&quot;&quot;</span>

    <span class="n">attribute_class</span> <span class="o">=</span> <span class="n">NTScalar</span>
    <span class="vm">__slots__</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

<div class="viewcode-block" id="StringMeta.validate"><a class="viewcode-back" href="../../../api/core_api.html#malcolm.core.StringMeta.validate">[docs]</a>    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Check if the value is valid returns it&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">doc_type_string</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;str&quot;</span>

    <span class="k">def</span> <span class="nf">default_widget</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Widget</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">writeable</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Widget</span><span class="o">.</span><span class="n">TEXTINPUT</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Widget</span><span class="o">.</span><span class="n">TEXTUPDATE</span></div>


<div class="viewcode-block" id="VArrayMeta"><a class="viewcode-back" href="../../../api/core_api.html#malcolm.core.VArrayMeta">[docs]</a><span class="k">class</span> <span class="nc">VArrayMeta</span><span class="p">(</span><span class="n">VMeta</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Intermediate abstract class so `TableMeta` can say &quot;only arrays&quot; &quot;&quot;&quot;</span>

    <span class="n">attribute_class</span> <span class="o">=</span> <span class="n">NTScalarArray</span>
    <span class="vm">__slots__</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span></div>


<span class="k">def</span> <span class="nf">to_np_array</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
    <span class="c1"># Give the Array the shorthand version</span>
    <span class="k">if</span> <span class="n">dtype</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">:</span>
        <span class="n">dtype</span> <span class="o">=</span> <span class="nb">float</span>
    <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">:</span>
        <span class="n">dtype</span> <span class="o">=</span> <span class="nb">int</span>
    <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="vm">__class__</span> <span class="ow">is</span> <span class="n">Array</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">seq</span><span class="p">,</span> <span class="s2">&quot;dtype&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="n">dtype</span><span class="p">:</span>
        <span class="c1"># If Array wraps a numpy array of the correct type we are done</span>
        <span class="k">return</span> <span class="n">value</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">):</span>
            <span class="c1"># Cast to numpy array</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">to_array</span><span class="p">(</span><span class="n">Array</span><span class="p">[</span><span class="n">dtype</span><span class="p">],</span> <span class="n">value</span><span class="p">)</span>


<div class="viewcode-block" id="BooleanArrayMeta"><a class="viewcode-back" href="../../../api/core_api.html#malcolm.core.BooleanArrayMeta">[docs]</a><span class="nd">@Serializable</span><span class="o">.</span><span class="n">register_subclass</span><span class="p">(</span><span class="s2">&quot;malcolm:core/BooleanArrayMeta:1.0&quot;</span><span class="p">)</span>
<span class="nd">@VMeta</span><span class="o">.</span><span class="n">register_annotype_converter</span><span class="p">(</span><span class="nb">bool</span><span class="p">,</span> <span class="n">is_array</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">BooleanArrayMeta</span><span class="p">(</span><span class="n">VArrayMeta</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Meta object containing information for a boolean array&quot;&quot;&quot;</span>

<div class="viewcode-block" id="BooleanArrayMeta.validate"><a class="viewcode-back" href="../../../api/core_api.html#malcolm.core.BooleanArrayMeta.validate">[docs]</a>    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Array</span><span class="p">[</span><span class="nb">bool</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Check if the value is valid returns it&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">to_np_array</span><span class="p">(</span><span class="nb">bool</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">doc_type_string</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;[bool]&quot;</span>

    <span class="k">def</span> <span class="nf">default_widget</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Widget</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">writeable</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Widget</span><span class="o">.</span><span class="n">CHECKBOX</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Widget</span><span class="o">.</span><span class="n">LED</span></div>


<div class="viewcode-block" id="ChoiceArrayMeta"><a class="viewcode-back" href="../../../api/core_api.html#malcolm.core.ChoiceArrayMeta">[docs]</a><span class="nd">@Serializable</span><span class="o">.</span><span class="n">register_subclass</span><span class="p">(</span><span class="s2">&quot;malcolm:core/ChoiceArrayMeta:1.0&quot;</span><span class="p">)</span>
<span class="nd">@VMeta</span><span class="o">.</span><span class="n">register_annotype_converter</span><span class="p">(</span><span class="n">Enum</span><span class="p">,</span> <span class="n">is_array</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">ChoiceArrayMeta</span><span class="p">(</span><span class="n">ChoiceMeta</span><span class="p">,</span> <span class="n">VArrayMeta</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Meta object containing information for a choice array&quot;&quot;&quot;</span>

<div class="viewcode-block" id="ChoiceArrayMeta.validate"><a class="viewcode-back" href="../../../api/core_api.html#malcolm.core.ChoiceArrayMeta.validate">[docs]</a>    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Array</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Check if the value is valid returns it&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Array</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">enum_cls</span><span class="p">]()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">value</span> <span class="o">=</span> <span class="p">[</span><span class="n">value</span><span class="p">]</span>
            <span class="c1"># If we have an Array of the right type, start off assuming it&#39;s the</span>
            <span class="c1"># same</span>
            <span class="n">is_same</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="vm">__class__</span> <span class="ow">is</span> <span class="n">Array</span> <span class="ow">and</span> <span class="n">value</span><span class="o">.</span><span class="n">typ</span> <span class="ow">is</span> <span class="bp">self</span><span class="o">.</span><span class="n">enum_cls</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">choice</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
                <span class="c1"># Our lookup table contains all the possible values</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">new_choice</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">choices_lookup</span><span class="p">[</span><span class="n">choice</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2"> is not a valid value in </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">choices</span><span class="si">}</span><span class="s2"> &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;for element </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">is_same</span> <span class="o">&amp;=</span> <span class="n">choice</span> <span class="o">==</span> <span class="n">new_choice</span>
                    <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_choice</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">is_same</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">value</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">to_array</span><span class="p">(</span><span class="n">Array</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">enum_cls</span><span class="p">],</span> <span class="n">ret</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">doc_type_string</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">doc_type_string</span><span class="p">()</span><span class="si">}</span><span class="s2">]&quot;</span></div>


<div class="viewcode-block" id="NumberArrayMeta"><a class="viewcode-back" href="../../../api/core_api.html#malcolm.core.NumberArrayMeta">[docs]</a><span class="nd">@Serializable</span><span class="o">.</span><span class="n">register_subclass</span><span class="p">(</span><span class="s2">&quot;malcolm:core/NumberArrayMeta:1.0&quot;</span><span class="p">)</span>
<span class="nd">@VMeta</span><span class="o">.</span><span class="n">register_annotype_converter</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">_dtype_string_lookup</span><span class="p">),</span> <span class="n">is_array</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">NumberArrayMeta</span><span class="p">(</span><span class="n">NumberMeta</span><span class="p">,</span> <span class="n">VArrayMeta</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Meta object containing information for an array of numerical values&quot;&quot;&quot;</span>

<div class="viewcode-block" id="NumberArrayMeta.validate"><a class="viewcode-back" href="../../../api/core_api.html#malcolm.core.NumberArrayMeta.validate">[docs]</a>    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Array</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Check if the value is valid returns it&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">to_np_array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_np_type</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">doc_type_string</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="si">}</span><span class="s2">]&quot;</span></div>


<div class="viewcode-block" id="StringArrayMeta"><a class="viewcode-back" href="../../../api/core_api.html#malcolm.core.StringArrayMeta">[docs]</a><span class="nd">@Serializable</span><span class="o">.</span><span class="n">register_subclass</span><span class="p">(</span><span class="s2">&quot;malcolm:core/StringArrayMeta:1.0&quot;</span><span class="p">)</span>
<span class="nd">@VMeta</span><span class="o">.</span><span class="n">register_annotype_converter</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">is_array</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">StringArrayMeta</span><span class="p">(</span><span class="n">VArrayMeta</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Meta object containing information for a string array&quot;&quot;&quot;</span>

<div class="viewcode-block" id="StringArrayMeta.validate"><a class="viewcode-back" href="../../../api/core_api.html#malcolm.core.StringArrayMeta.validate">[docs]</a>    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Array</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Check if the value is valid returns it&quot;&quot;&quot;</span>
        <span class="n">cast</span> <span class="o">=</span> <span class="n">to_array</span><span class="p">(</span><span class="n">Array</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">cast</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;Expected Array[str], got </span><span class="si">{</span><span class="n">value</span><span class="si">!r}</span><span class="s2">&quot;</span>
        <span class="k">return</span> <span class="n">cast</span></div>

    <span class="k">def</span> <span class="nf">doc_type_string</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;[str]&quot;</span>

    <span class="k">def</span> <span class="nf">default_widget</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Widget</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">writeable</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Widget</span><span class="o">.</span><span class="n">TEXTINPUT</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Widget</span><span class="o">.</span><span class="n">TEXTUPDATE</span></div>


<span class="k">with</span> <span class="n">Anno</span><span class="p">(</span><span class="s2">&quot;Elements that should appear in the table instance&quot;</span><span class="p">):</span>
    <span class="n">ATableElements</span> <span class="o">=</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">VArrayMeta</span><span class="p">]</span>


<div class="viewcode-block" id="TableMeta"><a class="viewcode-back" href="../../../api/core_api.html#malcolm.core.TableMeta">[docs]</a><span class="nd">@Serializable</span><span class="o">.</span><span class="n">register_subclass</span><span class="p">(</span><span class="s2">&quot;malcolm:core/TableMeta:1.0&quot;</span><span class="p">)</span>
<span class="nd">@VMeta</span><span class="o">.</span><span class="n">register_annotype_converter</span><span class="p">(</span><span class="n">Table</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">TableMeta</span><span class="p">(</span><span class="n">VMeta</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;elements&quot;</span><span class="p">]</span>
    <span class="n">attribute_class</span> <span class="o">=</span> <span class="n">NTTable</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">description</span><span class="p">:</span> <span class="n">AMetaDescription</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">tags</span><span class="p">:</span> <span class="n">UTags</span> <span class="o">=</span> <span class="p">(),</span>
        <span class="n">writeable</span><span class="p">:</span> <span class="n">AWriteable</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">label</span><span class="p">:</span> <span class="n">ALabel</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">elements</span><span class="p">:</span> <span class="n">ATableElements</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table_cls</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">Table</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Meta</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">description</span><span class="p">,</span> <span class="n">tags</span><span class="p">,</span> <span class="n">writeable</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>
        <span class="c1"># Do this after so writeable is honoured</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_elements</span><span class="p">(</span><span class="n">elements</span> <span class="k">if</span> <span class="n">elements</span> <span class="k">else</span> <span class="p">{})</span>

<div class="viewcode-block" id="TableMeta.set_elements"><a class="viewcode-back" href="../../../api/core_api.html#malcolm.core.TableMeta.set_elements">[docs]</a>    <span class="k">def</span> <span class="nf">set_elements</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">elements</span><span class="p">:</span> <span class="n">ATableElements</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ATableElements</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Set the elements dict from a serialized dict&quot;&quot;&quot;</span>
        <span class="n">deserialized</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">elements</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="s2">&quot;typeid&quot;</span><span class="p">:</span>
                <span class="n">deserialized</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">deserialize_object</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">VArrayMeta</span><span class="p">)</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_endpoint_data</span><span class="p">(</span><span class="s2">&quot;elements&quot;</span><span class="p">,</span> <span class="n">deserialized</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_table_cls</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">table_cls</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ret</span></div>

    <span class="k">def</span> <span class="nf">set_table_cls</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Table</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">table_cls</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">table_cls</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;TableSubclass&quot;</span><span class="p">:</span>
            <span class="c1"># Either autogenerated by this function or not set, so make one</span>

            <span class="k">class</span> <span class="nc">TableSubclass</span><span class="p">(</span><span class="n">Table</span><span class="p">):</span>
                <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

            <span class="n">table_cls</span> <span class="o">=</span> <span class="n">TableSubclass</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">meta</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="c1"># We can distinguish the type by asking for the default</span>
                <span class="c1"># validate value</span>
                <span class="n">default_array</span><span class="p">:</span> <span class="n">Array</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                <span class="n">anno</span> <span class="o">=</span> <span class="n">Anno</span><span class="p">(</span><span class="n">meta</span><span class="o">.</span><span class="n">description</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">k</span><span class="p">)</span><span class="o">.</span><span class="n">set_typ</span><span class="p">(</span>
                    <span class="n">default_array</span><span class="o">.</span><span class="n">typ</span><span class="p">,</span> <span class="n">is_array</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>
                <span class="n">table_cls</span><span class="o">.</span><span class="n">call_types</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">anno</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># User supplied, check it matches element names</span>
            <span class="k">assert</span> <span class="n">Table</span><span class="o">.</span><span class="n">matches_type</span><span class="p">(</span>
                <span class="n">table_cls</span>
            <span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;Expecting table subclass, got </span><span class="si">{</span><span class="n">table_cls</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">missing</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">table_cls</span><span class="o">.</span><span class="n">call_types</span><span class="p">)</span>
            <span class="k">assert</span> <span class="ow">not</span> <span class="n">missing</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Supplied Table missing fields </span><span class="si">{</span><span class="n">missing</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">extra</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">table_cls</span><span class="o">.</span><span class="n">call_types</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="p">)</span>
            <span class="k">assert</span> <span class="ow">not</span> <span class="n">extra</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Supplied Table has extra fields </span><span class="si">{</span><span class="n">extra</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table_cls</span> <span class="o">=</span> <span class="n">table_cls</span>

    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Create an empty table</span>
            <span class="n">value</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="p">}</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Table</span><span class="p">):</span>
            <span class="c1"># Serialize a single level so we can type check it</span>
            <span class="n">value</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">value</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">call_types</span><span class="p">}</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Expected Table instance or serialized, got </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># We need to make a table instance ourselves</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">value</span> <span class="k">if</span> <span class="n">x</span> <span class="o">!=</span> <span class="s2">&quot;typeid&quot;</span><span class="p">)</span>
        <span class="n">missing</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="p">)</span> <span class="o">-</span> <span class="n">keys</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="n">missing</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Supplied table missing fields </span><span class="si">{</span><span class="n">missing</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">extra</span> <span class="o">=</span> <span class="n">keys</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="p">)</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="n">extra</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Supplied table has extra fields </span><span class="si">{</span><span class="n">extra</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">meta</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">meta</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">table_cls</span><span class="p">,</span> <span class="s2">&quot;No table set&quot;</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table_cls</span><span class="p">(</span><span class="o">**</span><span class="n">args</span><span class="p">)</span>
        <span class="c1"># Check column lengths</span>
        <span class="n">value</span><span class="o">.</span><span class="n">validate_column_lengths</span><span class="p">()</span>
        <span class="c1"># Check the table class give Array elements</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="k">assert</span> <span class="p">(</span>
                <span class="n">value</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="vm">__class__</span> <span class="ow">is</span> <span class="n">Array</span>
            <span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;Table Class </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">table_cls</span><span class="si">}</span><span class="s2"> doesn&#39;t wrap attr &#39;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&#39; with an Array&quot;</span>
        <span class="k">return</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">doc_type_string</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;`Table`&quot;</span>

    <span class="k">def</span> <span class="nf">default_widget</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Widget</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Widget</span><span class="o">.</span><span class="n">TABLE</span>

<div class="viewcode-block" id="TableMeta.from_table"><a class="viewcode-back" href="../../../api/core_api.html#malcolm.core.TableMeta.from_table">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_table</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">table_cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Table</span><span class="p">],</span>
        <span class="n">description</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">widget</span><span class="p">:</span> <span class="n">Widget</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">writeable</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[],</span>
        <span class="n">extra_tags</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;TableMeta&quot;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create a TableMeta object, using a Table subclass as the spec</span>

<span class="sd">        Args:</span>
<span class="sd">            table_cls: The Table class to read __init__ args from</span>
<span class="sd">            description: The description of the created Meta</span>
<span class="sd">            widget: The widget of the created Meta</span>
<span class="sd">            writeable: A list of the writeable field names. If there are any</span>
<span class="sd">                writeable fields then the whole Meta is writeable</span>
<span class="sd">            extra_tags: A list of tags to be added to the table meta</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">elements</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">ct</span> <span class="ow">in</span> <span class="n">table_cls</span><span class="o">.</span><span class="n">call_types</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">subclass</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">lookup_annotype_converter</span><span class="p">(</span><span class="n">ct</span><span class="p">)</span>
            <span class="n">elements</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">subclass</span><span class="o">.</span><span class="n">from_annotype</span><span class="p">(</span><span class="n">ct</span><span class="p">,</span> <span class="n">writeable</span><span class="o">=</span><span class="n">k</span> <span class="ow">in</span> <span class="n">writeable</span><span class="p">)</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">,</span> <span class="n">elements</span><span class="o">=</span><span class="n">elements</span><span class="p">,</span> <span class="n">writeable</span><span class="o">=</span><span class="nb">bool</span><span class="p">(</span><span class="n">writeable</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">widget</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">widget</span> <span class="o">=</span> <span class="n">ret</span><span class="o">.</span><span class="n">default_widget</span><span class="p">()</span>
        <span class="n">tags</span> <span class="o">=</span> <span class="p">[</span><span class="n">widget</span><span class="o">.</span><span class="n">tag</span><span class="p">()]</span>
        <span class="n">tags</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">extra_tags</span><span class="p">)</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">set_tags</span><span class="p">(</span><span class="n">tags</span><span class="p">)</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">set_table_cls</span><span class="p">(</span><span class="n">table_cls</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ret</span></div>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_annotype</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">anno</span><span class="p">:</span> <span class="n">Anno</span><span class="p">,</span> <span class="n">writeable</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">VMeta</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">Table</span><span class="o">.</span><span class="n">matches_type</span><span class="p">(</span><span class="n">anno</span><span class="o">.</span><span class="n">typ</span><span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;Expected Table, got </span><span class="si">{</span><span class="n">anno</span><span class="o">.</span><span class="n">typ</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">writeable</span><span class="p">:</span>
            <span class="c1"># All fields are writeable</span>
            <span class="n">writeable_fields</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">anno</span><span class="o">.</span><span class="n">typ</span><span class="o">.</span><span class="n">call_types</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># No fields are writeable</span>
            <span class="n">writeable_fields</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">from_table</span><span class="p">(</span><span class="n">anno</span><span class="o">.</span><span class="n">typ</span><span class="p">,</span> <span class="n">anno</span><span class="o">.</span><span class="n">description</span><span class="p">,</span> <span class="n">writeable</span><span class="o">=</span><span class="n">writeable_fields</span><span class="p">)</span></div>


<span class="c1"># Types used when deserializing to the class</span>
<span class="k">with</span> <span class="n">Anno</span><span class="p">(</span><span class="s2">&quot;Meta objects that are used to describe the elements in the map&quot;</span><span class="p">):</span>
    <span class="n">AElements</span> <span class="o">=</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">VMeta</span><span class="p">]</span>
<span class="k">with</span> <span class="n">Anno</span><span class="p">(</span><span class="s2">&quot;The required elements in the map&quot;</span><span class="p">):</span>
    <span class="n">ARequired</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="n">Array</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span>

<span class="c1"># A more permissive union to allow a wider range of set_* args</span>
<span class="n">URequired</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="n">ARequired</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">str</span><span class="p">]</span>


<div class="viewcode-block" id="MapMeta"><a class="viewcode-back" href="../../../api/core_api.html#malcolm.core.MapMeta">[docs]</a><span class="nd">@Serializable</span><span class="o">.</span><span class="n">register_subclass</span><span class="p">(</span><span class="s2">&quot;malcolm:core/MapMeta:1.0&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">MapMeta</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;An object containing a set of ScalarMeta objects&quot;&quot;&quot;</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;elements&quot;</span><span class="p">,</span> <span class="s2">&quot;required&quot;</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">elements</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AElements</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">required</span><span class="p">:</span> <span class="n">URequired</span> <span class="o">=</span> <span class="p">()</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elements</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_elements</span><span class="p">(</span><span class="n">elements</span> <span class="k">if</span> <span class="n">elements</span> <span class="k">else</span> <span class="p">{})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">required</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_required</span><span class="p">(</span><span class="n">required</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_elements</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">elements</span><span class="p">:</span> <span class="n">AElements</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AElements</span><span class="p">:</span>
        <span class="n">deserialized</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">elements</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="s2">&quot;typeid&quot;</span><span class="p">:</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">deserialize_object</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">VMeta</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">v</span><span class="o">.</span><span class="n">label</span><span class="p">:</span>
                    <span class="n">v</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="n">camel_to_title</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
                <span class="n">deserialized</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_endpoint_data</span><span class="p">(</span><span class="s2">&quot;elements&quot;</span><span class="p">,</span> <span class="n">deserialized</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_required</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">required</span><span class="p">:</span> <span class="n">URequired</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ARequired</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">required</span><span class="p">:</span>
            <span class="k">assert</span> <span class="p">(</span>
                <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span>
            <span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;Expected one of </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="p">)</span><span class="si">!r}</span><span class="s2">, got </span><span class="si">{</span><span class="n">r</span><span class="si">!r}</span><span class="s2">&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_endpoint_data</span><span class="p">(</span><span class="s2">&quot;required&quot;</span><span class="p">,</span> <span class="n">ARequired</span><span class="p">(</span><span class="n">required</span><span class="p">))</span>

<div class="viewcode-block" id="MapMeta.validate"><a class="viewcode-back" href="../../../api/core_api.html#malcolm.core.MapMeta.validate">[docs]</a>    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">param_dict</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">add_missing</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Return a param dict in the right order, with the correct keys and</span>
<span class="sd">        values of the correct type with no extras or missing&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">param_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">param_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">extra</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">param_dict</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="p">)</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="n">extra</span><span class="p">,</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Given keys </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">param_dict</span><span class="p">))</span><span class="si">}</span><span class="s2">, some of which aren&#39;t &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;in allowed keys </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">param_dict</span><span class="p">:</span>
                <span class="n">args</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">param_dict</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">add_missing</span><span class="p">:</span>
                <span class="n">args</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">missing</span><span class="p">:</span> <span class="n">Set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">required</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="ow">not</span> <span class="n">missing</span>
        <span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;Requires keys </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">required</span><span class="p">)</span><span class="si">}</span><span class="s2"> but only given </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">return</span> <span class="n">args</span></div></div>


<span class="c1"># Types used when deserializing to the class</span>
<span class="k">with</span> <span class="n">Anno</span><span class="p">(</span><span class="s2">&quot;Meta for describing the arguments that should be passed&quot;</span><span class="p">):</span>
    <span class="n">ATakes</span> <span class="o">=</span> <span class="n">MapMeta</span>
<span class="k">with</span> <span class="n">Anno</span><span class="p">(</span><span class="s2">&quot;The required elements in the map&quot;</span><span class="p">):</span>
    <span class="n">ADefaults</span> <span class="o">=</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
<span class="k">with</span> <span class="n">Anno</span><span class="p">(</span><span class="s2">&quot;Meta for describing the arguments that will be returned&quot;</span><span class="p">):</span>
    <span class="n">AReturns</span> <span class="o">=</span> <span class="n">MapMeta</span>


<div class="viewcode-block" id="MethodMeta"><a class="viewcode-back" href="../../../api/core_api.html#malcolm.core.MethodMeta">[docs]</a><span class="nd">@Serializable</span><span class="o">.</span><span class="n">register_subclass</span><span class="p">(</span><span class="s2">&quot;malcolm:core/MethodMeta:1.1&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">MethodMeta</span><span class="p">(</span><span class="n">Meta</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Exposes a function with metadata for arguments and return values&quot;&quot;&quot;</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;takes&quot;</span><span class="p">,</span> <span class="s2">&quot;returns&quot;</span><span class="p">,</span> <span class="s2">&quot;defaults&quot;</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">takes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ATakes</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">defaults</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ADefaults</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">description</span><span class="p">:</span> <span class="n">AMetaDescription</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">tags</span><span class="p">:</span> <span class="n">UTags</span> <span class="o">=</span> <span class="p">(),</span>
        <span class="n">writeable</span><span class="p">:</span> <span class="n">AWriteable</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">label</span><span class="p">:</span> <span class="n">ALabel</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">returns</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AReturns</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">takes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_takes</span><span class="p">(</span><span class="n">takes</span> <span class="k">if</span> <span class="n">takes</span> <span class="k">else</span> <span class="n">MapMeta</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">returns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_returns</span><span class="p">(</span><span class="n">returns</span> <span class="k">if</span> <span class="n">returns</span> <span class="k">else</span> <span class="n">MapMeta</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span><span class="n">defaults</span> <span class="k">if</span> <span class="n">defaults</span> <span class="k">else</span> <span class="p">{})</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">description</span><span class="p">,</span> <span class="n">tags</span><span class="p">,</span> <span class="n">writeable</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_takes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">takes</span><span class="p">:</span> <span class="n">ATakes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ATakes</span><span class="p">:</span>
        <span class="n">takes</span> <span class="o">=</span> <span class="n">deserialize_object</span><span class="p">(</span><span class="n">takes</span><span class="p">,</span> <span class="n">MapMeta</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_endpoint_data</span><span class="p">(</span><span class="s2">&quot;takes&quot;</span><span class="p">,</span> <span class="n">takes</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_defaults</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">defaults</span><span class="p">:</span> <span class="n">ADefaults</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ADefaults</span><span class="p">:</span>
        <span class="n">defaults</span> <span class="o">=</span> <span class="n">FrozenOrderedDict</span><span class="p">(</span>
            <span class="nb">tuple</span><span class="p">(</span>
                <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">takes</span><span class="o">.</span><span class="n">elements</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">defaults</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="s2">&quot;typeid&quot;</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_endpoint_data</span><span class="p">(</span><span class="s2">&quot;defaults&quot;</span><span class="p">,</span> <span class="n">defaults</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_returns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">returns</span><span class="p">:</span> <span class="n">AReturns</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AReturns</span><span class="p">:</span>
        <span class="n">returns</span> <span class="o">=</span> <span class="n">deserialize_object</span><span class="p">(</span><span class="n">returns</span><span class="p">,</span> <span class="n">MapMeta</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_endpoint_data</span><span class="p">(</span><span class="s2">&quot;returns&quot;</span><span class="p">,</span> <span class="n">returns</span><span class="p">)</span>

<div class="viewcode-block" id="MethodMeta.from_callable"><a class="viewcode-back" href="../../../api/core_api.html#malcolm.core.MethodMeta.from_callable">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_callable</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span>
        <span class="n">description</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">returns</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">without_takes</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">(),</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;MethodMeta&quot;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return an instance of this class from a Callable</span>

<span class="sd">        Args:</span>
<span class="sd">            func: @with_call_types decorated Callable to inspect</span>
<span class="sd">            description: Override description. If None use func.__doc__</span>
<span class="sd">            returns: If True then scan return_type too</span>
<span class="sd">            without_takes: A sequence of strings that should not appear in the</span>
<span class="sd">                takes structure</span>

<span class="sd">        Returns:</span>
<span class="sd">            A MethodMeta with takes and returns matching the input func</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">description</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">func</span><span class="o">.</span><span class="vm">__doc__</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">description</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="vm">__doc__</span>
        <span class="n">method</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">)</span>
        <span class="n">tags</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">takes_elements</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="n">defaults</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="n">takes_required</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">without_takes_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">without_takes</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">anno</span> <span class="ow">in</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="s2">&quot;call_types&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">without_takes_set</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">scls</span> <span class="o">=</span> <span class="n">VMeta</span><span class="o">.</span><span class="n">lookup_annotype_converter</span><span class="p">(</span><span class="n">anno</span><span class="p">)</span>
            <span class="n">takes_elements</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">scls</span><span class="o">.</span><span class="n">from_annotype</span><span class="p">(</span><span class="n">anno</span><span class="p">,</span> <span class="n">writeable</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">anno</span><span class="o">.</span><span class="n">default</span> <span class="ow">is</span> <span class="n">NO_DEFAULT</span><span class="p">:</span>
                <span class="n">takes_required</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">anno</span><span class="o">.</span><span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">defaults</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">anno</span><span class="o">.</span><span class="n">default</span>
        <span class="n">takes</span> <span class="o">=</span> <span class="n">MapMeta</span><span class="p">(</span><span class="n">elements</span><span class="o">=</span><span class="n">takes_elements</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="n">takes_required</span><span class="p">)</span>
        <span class="n">method</span><span class="o">.</span><span class="n">set_takes</span><span class="p">(</span><span class="n">takes</span><span class="p">)</span>
        <span class="n">method</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span><span class="n">defaults</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">returns</span><span class="p">:</span>
            <span class="n">returns_elements</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
            <span class="n">returns_required</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">return_type</span><span class="p">:</span> <span class="n">Anno</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="s2">&quot;return_type&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">return_type</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">return_type</span><span class="o">.</span><span class="n">typ</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">call_types</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">elif</span> <span class="n">WithCallTypes</span><span class="o">.</span><span class="n">matches_type</span><span class="p">(</span><span class="n">return_type</span><span class="o">.</span><span class="n">typ</span><span class="p">):</span>
                <span class="n">call_types</span> <span class="o">=</span> <span class="n">return_type</span><span class="o">.</span><span class="n">typ</span><span class="o">.</span><span class="n">call_types</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">method_return_unpacked</span><span class="p">())</span>
                <span class="n">call_types</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;return&quot;</span><span class="p">:</span> <span class="n">return_type</span><span class="p">}</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">anno</span> <span class="ow">in</span> <span class="n">call_types</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">scls</span> <span class="o">=</span> <span class="n">VMeta</span><span class="o">.</span><span class="n">lookup_annotype_converter</span><span class="p">(</span><span class="n">anno</span><span class="p">)</span>
                <span class="n">returns_elements</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">scls</span><span class="o">.</span><span class="n">from_annotype</span><span class="p">(</span><span class="n">anno</span><span class="p">,</span> <span class="n">writeable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">anno</span><span class="o">.</span><span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">returns_required</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
            <span class="n">returns</span> <span class="o">=</span> <span class="n">MapMeta</span><span class="p">(</span><span class="n">elements</span><span class="o">=</span><span class="n">returns_elements</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="n">returns_required</span><span class="p">)</span>
            <span class="n">method</span><span class="o">.</span><span class="n">set_returns</span><span class="p">(</span><span class="n">returns</span><span class="p">)</span>
        <span class="n">method</span><span class="o">.</span><span class="n">set_tags</span><span class="p">(</span><span class="n">tags</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">method</span></div></div>


<span class="c1"># Types used when deserializing to the class</span>
<span class="k">with</span> <span class="n">Anno</span><span class="p">(</span><span class="s2">&quot;The last map this took/returned&quot;</span><span class="p">):</span>
    <span class="n">AMVValue</span> <span class="o">=</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
<span class="k">with</span> <span class="n">Anno</span><span class="p">(</span><span class="s2">&quot;The elements that were supplied in the map&quot;</span><span class="p">):</span>
    <span class="n">APresent</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="n">Array</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span>

<span class="c1"># A more permissive union to allow a wider range of set_* args</span>
<span class="n">UPresent</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="n">APresent</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">str</span><span class="p">]</span>


<div class="viewcode-block" id="MethodLog"><a class="viewcode-back" href="../../../api/core_api.html#malcolm.core.MethodLog">[docs]</a><span class="nd">@Serializable</span><span class="o">.</span><span class="n">register_subclass</span><span class="p">(</span><span class="s2">&quot;malcolm:core/MethodLog:1.0&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">MethodLog</span><span class="p">(</span><span class="n">Serializable</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Exposes a function with metadata for arguments and return values&quot;&quot;&quot;</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">,</span> <span class="s2">&quot;alarm&quot;</span><span class="p">,</span> <span class="s2">&quot;timeStamp&quot;</span><span class="p">]</span>

    <span class="c1"># noinspection PyPep8Naming</span>
    <span class="c1"># timeStamp is camelCase to maintain compatibility with EPICS normative</span>
    <span class="c1"># types</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">value</span><span class="p">:</span> <span class="n">AMVValue</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">present</span><span class="p">:</span> <span class="n">UPresent</span> <span class="o">=</span> <span class="p">(),</span>
        <span class="n">alarm</span><span class="p">:</span> <span class="n">AAlarm</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">timeStamp</span><span class="p">:</span> <span class="n">ATimeStamp</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">,</span> <span class="n">AMVValue</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">present</span> <span class="o">=</span> <span class="n">APresent</span><span class="p">(</span><span class="n">present</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">alarm</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">alarm</span> <span class="o">=</span> <span class="n">Alarm</span><span class="o">.</span><span class="n">ok</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">alarm</span> <span class="o">=</span> <span class="n">deserialize_object</span><span class="p">(</span><span class="n">alarm</span><span class="p">,</span> <span class="n">Alarm</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">timeStamp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">timeStamp</span> <span class="o">=</span> <span class="n">TimeStamp</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">timeStamp</span> <span class="o">=</span> <span class="n">deserialize_object</span><span class="p">(</span><span class="n">timeStamp</span><span class="p">,</span> <span class="n">TimeStamp</span><span class="p">)</span></div>


<span class="c1"># Types used when deserializing to the class</span>
<span class="k">with</span> <span class="n">Anno</span><span class="p">(</span><span class="s2">&quot;The last arguments that a method call took&quot;</span><span class="p">):</span>
    <span class="n">ATook</span> <span class="o">=</span> <span class="n">MethodLog</span>
<span class="k">with</span> <span class="n">Anno</span><span class="p">(</span><span class="s2">&quot;The last return value produced by a method call&quot;</span><span class="p">):</span>
    <span class="n">AReturned</span> <span class="o">=</span> <span class="n">MethodLog</span>
<span class="k">with</span> <span class="n">Anno</span><span class="p">(</span><span class="s2">&quot;Meta for describing the arguments that will be returned&quot;</span><span class="p">):</span>
    <span class="n">AMethodMeta</span> <span class="o">=</span> <span class="n">MethodMeta</span>


<div class="viewcode-block" id="MethodModel"><a class="viewcode-back" href="../../../api/core_api.html#malcolm.core.MethodModel">[docs]</a><span class="nd">@Serializable</span><span class="o">.</span><span class="n">register_subclass</span><span class="p">(</span><span class="s2">&quot;malcolm:core/Method:1.1&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">MethodModel</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Exposes a function with last took and returned arguments&quot;&quot;&quot;</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;took&quot;</span><span class="p">,</span> <span class="s2">&quot;returned&quot;</span><span class="p">,</span> <span class="s2">&quot;meta&quot;</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">took</span><span class="p">:</span> <span class="n">ATook</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">returned</span><span class="p">:</span> <span class="n">AReturned</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">meta</span><span class="p">:</span> <span class="n">AMethodMeta</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_meta</span><span class="p">(</span><span class="n">meta</span> <span class="k">if</span> <span class="n">meta</span> <span class="k">else</span> <span class="n">MethodMeta</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">took</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_took</span><span class="p">(</span><span class="n">took</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">returned</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_returned</span><span class="p">(</span><span class="n">returned</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_meta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">meta</span><span class="p">:</span> <span class="n">AMethodMeta</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AMethodMeta</span><span class="p">:</span>
        <span class="n">meta</span> <span class="o">=</span> <span class="n">deserialize_object</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span> <span class="n">MethodMeta</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_endpoint_data</span><span class="p">(</span><span class="s2">&quot;meta&quot;</span><span class="p">,</span> <span class="n">meta</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_took</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">took</span><span class="p">:</span> <span class="n">ATook</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ATook</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">took</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">took</span> <span class="o">=</span> <span class="n">MethodLog</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">takes</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">add_missing</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="p">[],</span> <span class="n">Alarm</span><span class="o">.</span><span class="n">ok</span><span class="p">,</span> <span class="n">TimeStamp</span><span class="o">.</span><span class="n">zero</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">took</span> <span class="o">=</span> <span class="n">deserialize_object</span><span class="p">(</span><span class="n">took</span><span class="p">,</span> <span class="n">MethodLog</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_endpoint_data</span><span class="p">(</span><span class="s2">&quot;took&quot;</span><span class="p">,</span> <span class="n">took</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_returned</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">returned</span><span class="p">:</span> <span class="n">AReturned</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AReturned</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">returned</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">returned</span> <span class="o">=</span> <span class="n">MethodLog</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">returns</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">add_missing</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
                <span class="p">[],</span>
                <span class="n">Alarm</span><span class="o">.</span><span class="n">ok</span><span class="p">,</span>
                <span class="n">TimeStamp</span><span class="o">.</span><span class="n">zero</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">returned</span> <span class="o">=</span> <span class="n">deserialize_object</span><span class="p">(</span><span class="n">returned</span><span class="p">,</span> <span class="n">MethodLog</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_endpoint_data</span><span class="p">(</span><span class="s2">&quot;returned&quot;</span><span class="p">,</span> <span class="n">returned</span><span class="p">)</span></div>


<span class="c1"># Types used when deserializing to the class</span>
<span class="k">with</span> <span class="n">Anno</span><span class="p">(</span><span class="s2">&quot;The list of fields currently in the Block&quot;</span><span class="p">):</span>
    <span class="n">AFields</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="n">Array</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span>

<span class="c1"># A more permissive union to allow a wider range of set_* args</span>
<span class="n">UFields</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="n">AFields</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">str</span><span class="p">]</span>


<div class="viewcode-block" id="BlockMeta"><a class="viewcode-back" href="../../../api/core_api.html#malcolm.core.BlockMeta">[docs]</a><span class="nd">@Serializable</span><span class="o">.</span><span class="n">register_subclass</span><span class="p">(</span><span class="s2">&quot;malcolm:core/BlockMeta:1.0&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">BlockMeta</span><span class="p">(</span><span class="n">Meta</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;fields&quot;</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">description</span><span class="p">:</span> <span class="n">AMetaDescription</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">tags</span><span class="p">:</span> <span class="n">UTags</span> <span class="o">=</span> <span class="p">(),</span>
        <span class="n">writeable</span><span class="p">:</span> <span class="n">AWriteable</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">label</span><span class="p">:</span> <span class="n">ALabel</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">fields</span><span class="p">:</span> <span class="n">UFields</span> <span class="o">=</span> <span class="p">(),</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">description</span><span class="p">,</span> <span class="n">tags</span><span class="p">,</span> <span class="n">writeable</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_fields</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fields</span><span class="p">:</span> <span class="n">UFields</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AFields</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_endpoint_data</span><span class="p">(</span><span class="s2">&quot;fields&quot;</span><span class="p">,</span> <span class="n">AFields</span><span class="p">(</span><span class="n">fields</span><span class="p">))</span></div>


<div class="viewcode-block" id="BlockModel"><a class="viewcode-back" href="../../../api/core_api.html#malcolm.core.BlockModel">[docs]</a><span class="nd">@Serializable</span><span class="o">.</span><span class="n">register_subclass</span><span class="p">(</span><span class="s2">&quot;malcolm:core/Block:1.0&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">BlockModel</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Data Model for a Block&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Make a new call_types dict so we don&#39;t modify for all instances</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call_types</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_endpoint_data</span><span class="p">(</span><span class="s2">&quot;meta&quot;</span><span class="p">,</span> <span class="n">BlockMeta</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">set_endpoint_data</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">value</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">AttributeModel</span><span class="p">,</span> <span class="n">MethodModel</span><span class="p">,</span> <span class="n">BlockMeta</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">deserialize_object</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;meta&quot;</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">deserialize_object</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">BlockMeta</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">deserialize_object</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="n">AttributeModel</span><span class="p">,</span> <span class="n">MethodModel</span><span class="p">))</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">notifier</span><span class="o">.</span><span class="n">changes_squashed</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">call_types</span><span class="p">:</span>
                <span class="c1"># Stop the old Model notifying</span>
                <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">set_notifier_path</span><span class="p">(</span><span class="n">Model</span><span class="o">.</span><span class="n">notifier</span><span class="p">,</span> <span class="p">[])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">anno</span> <span class="o">=</span> <span class="n">Anno</span><span class="p">(</span><span class="s2">&quot;Field&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">set_typ</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">call_types</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">anno</span>
            <span class="n">value</span><span class="o">.</span><span class="n">set_notifier_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">notifier</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">+</span> <span class="p">[</span><span class="n">name</span><span class="p">])</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="c1"># Tell the notifier what changed</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">notifier</span><span class="o">.</span><span class="n">add_squashed_change</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">+</span> <span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="n">value</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_fields</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">_update_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">set_fields</span><span class="p">([</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">call_types</span> <span class="k">if</span> <span class="n">x</span> <span class="o">!=</span> <span class="s2">&quot;meta&quot;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">remove_endpoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">notifier</span><span class="o">.</span><span class="n">changes_squashed</span><span class="p">:</span>
            <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">set_notifier_path</span><span class="p">(</span><span class="n">Model</span><span class="o">.</span><span class="n">notifier</span><span class="p">,</span> <span class="p">[])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">call_types</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="nb">delattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_fields</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">notifier</span><span class="o">.</span><span class="n">add_squashed_delete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">+</span> <span class="p">[</span><span class="n">name</span><span class="p">])</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2015, Diamond Light Source.</p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
 <script type="text/javascript">
    $(document).ready(function() {
        $(".toggle > *").hide();
        $(".toggle .header").show();
        $(".toggle .header").click(function() {
            $(this).parent().children().not(".header").toggle(400);
            $(this).parent().children(".header").toggleClass("open");
        })
    });
</script>


</body>
</html>